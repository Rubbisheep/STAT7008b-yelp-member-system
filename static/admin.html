<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Rhythm Admin | Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
            brand: { 500: '#6366f1', 600: '#4f46e5' }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #0f172a; color: #e2e8f0; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; transition: all 0.3s; }
    .card:hover { border-color: #6366f1; box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.2); }

    .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.6; transform: none; cursor: not-allowed; }

    .btn-secondary { background: transparent; border: 1px solid #475569; color: #cbd5e1; }
    .btn-secondary:hover:not(:disabled) { background: #334155; border-color: #64748b; }
    .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

    .glass-nav { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid #334155; }

    /* 滚动条 */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

    .chart-box { min-height: 200px; display: flex; align-items: center; justify-content: center; background: #0f172a; border-radius: 0.5rem; overflow: hidden; position: relative; }

    /* 图片样式：增加鼠标手势和过渡 */
    .chart-box img {
        width: 100%; height: 100%; object-fit: contain;
        cursor: zoom-in;
        transition: transform 0.2s;
    }
    .chart-box img:hover { transform: scale(1.02); opacity: 0.9; }

    /* Lightbox 动画 */
    #lightbox { transition: opacity 0.3s ease; }
    #lightbox.hidden { opacity: 0; pointer-events: none; }
    #lightbox:not(.hidden) { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body class="h-screen flex overflow-hidden">

  <div id="lightbox" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeLightbox()">
    <div class="relative max-w-7xl max-h-full">
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl border border-slate-700">
        <button class="absolute -top-10 right-0 text-white text-3xl hover:text-brand-500 transition" onclick="closeLightbox()">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <p class="text-center text-slate-400 mt-2 text-sm">Click anywhere to close</p>
    </div>
  </div>

  <aside class="w-64 bg-slate-900 border-r border-slate-800 flex-col hidden md:flex z-20">
    <div class="h-16 flex items-center px-6 border-b border-slate-800">
      <i class="fa-solid fa-wave-square text-brand-500 text-2xl mr-3"></i>
      <span class="font-bold text-xl tracking-wider text-white">RHYTHM</span>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <div class="text-xs font-bold text-slate-500 uppercase px-3 mt-4 mb-2">Main</div>
      <a href="#" class="flex items-center px-4 py-3 bg-brand-600 text-white rounded-xl shadow-lg shadow-indigo-900/50">
        <i class="fa-solid fa-chart-simple w-6"></i> Dashboard
      </a>
      <a href="#inspector" class="flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-xl transition">
        <i class="fa-solid fa-users-viewfinder w-6"></i> Inspector
      </a>
    </nav>
    <div class="p-4 border-t border-slate-800">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-emerald-400 to-cyan-500"></div>
        <div>
          <div class="text-sm font-bold text-white">Admin</div>
          <div class="text-xs text-emerald-400">● Online</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col relative">
    <header class="glass-nav h-16 flex items-center justify-between px-8 z-10">
      <h1 class="text-lg font-bold text-slate-200">Analytics Overview</h1>
      <div class="flex gap-4">
        <button class="w-10 h-10 rounded-full bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition flex items-center justify-center">
          <i class="fa-regular fa-bell"></i>
        </button>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8 space-y-8 scroll-smooth">

      <section class="card p-6 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500 rounded-full mix-blend-overlay filter blur-3xl opacity-10 pointer-events-none"></div>
        <div class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
          <div>
            <h2 class="text-xl font-bold text-white">Simulation Center</h2>
            <p class="text-slate-400 text-sm mt-1">Control the synthetic data pipeline. <span class="text-amber-400">Warning: Generating 3k users may take 10-20 seconds.</span></p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button onclick="triggerTask('init_db', this)" class="btn-secondary px-5 py-2.5 rounded-lg transition flex items-center gap-2">
              <i class="fa-solid fa-rotate-left"></i> Reset DB
            </button>
            <button onclick="triggerTask('simulate_data', this)" class="btn-secondary px-5 py-2.5 rounded-lg transition flex items-center gap-2">
              <i class="fa-solid fa-robot text-emerald-400"></i> Simulate Users (3k)
            </button>
            <button onclick="triggerTask('generate_dashboard', this)" class="btn-primary px-6 py-2.5 rounded-lg shadow-lg shadow-indigo-500/30 transition flex items-center gap-2 font-medium">
              <i class="fa-solid fa-chart-pie"></i> Generate Reports
            </button>
          </div>
        </div>
        <div id="console-log" class="mt-6 p-4 bg-black/30 rounded-lg font-mono text-xs text-slate-400 hidden border-l-2 border-brand-500 max-h-40 overflow-y-auto"></div>
      </section>

      <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div class="card p-5">
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-300">User Growth</h3>
            <i class="fa-solid fa-arrow-trend-up text-emerald-400"></i>
          </div>
          <div class="chart-box">
            <img id="chart-trend" src="/outputs/register_trend.png" onclick="openLightbox(this.src)" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\'text-slate-600 text-xs flex flex-col items-center\'><i class=\'fa-solid fa-image mb-2 text-2xl\'></i><span>Run Generate Reports</span></div>'">
          </div>
        </div>

        <div class="card p-5">
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-300">Active Users (DAU)</h3>
            <i class="fa-solid fa-users text-amber-400"></i>
          </div>
          <div class="chart-box">
            <img id="chart-dau" src="/outputs/dau.png" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
          </div>
        </div>

        <div class="card p-5">
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-300">Segments</h3>
            <i class="fa-solid fa-layer-group text-purple-400"></i>
          </div>
          <div class="chart-box">
            <img id="chart-seg" src="/outputs/segments.png" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
          </div>
        </div>

        <div class="card p-5 md:col-span-2">
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-300">Activity Heatmap (Week vs Hour)</h3>
            <i class="fa-solid fa-fire text-rose-400"></i>
          </div>
          <div class="chart-box h-64">
            <img id="chart-heat" src="/outputs/activity_heatmap.png" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
          </div>
        </div>

        <div class="card p-5">
          <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-300">Retention</h3>
            <i class="fa-solid fa-magnet text-cyan-400"></i>
          </div>
          <div class="chart-box h-64">
            <img id="chart-ret" src="/outputs/retention.png" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
          </div>
        </div>
      </section>

      <section id="inspector" class="card p-6 mb-10">
        <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-700 pb-6 mb-6">
          <div>
            <h2 class="text-xl font-bold text-white">User Inspector</h2>
            <p class="text-slate-400 text-sm">Search database for user profiles and history.</p>
          </div>
          <form onsubmit="searchUser(event)" class="flex w-full md:w-auto gap-2">
            <input id="search-q" type="text" placeholder="Nickname or Email..." class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5 outline-none">
            <button type="submit" class="p-2.5 px-5 text-sm font-medium text-white bg-slate-700 rounded-lg border border-slate-600 hover:bg-slate-600 focus:ring-4 focus:outline-none focus:ring-slate-700">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </form>
        </div>
        <div id="search-res" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 min-h-[150px]">
          <div class="col-span-full flex flex-col items-center justify-center text-slate-600">
            <i class="fa-brands fa-searchengin text-4xl mb-2 opacity-20"></i>
            <span class="text-sm">Ready to search</span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // 强制指向本地后端端口，避免文件打开模式下的跨域问题
    const API = "http://localhost:8001";
    const logEl = document.getElementById("console-log");

    // --- Lightbox Functions ---
    function openLightbox(src) {
        if (!src || src.includes('onerror')) return;
        const lb = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        img.src = src;
        lb.classList.remove('hidden');
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.add('hidden');
    }

    // --- Utility Functions ---
    function log(msg, type='info') {
        logEl.style.display = 'block';
        const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : 'text-slate-300');
        const icon = type === 'error' ? '!' : (type === 'success' ? '✓' : '>');
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div class="${color} mb-1"><span class="opacity-50">[${time}]</span> ${icon} ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- Action Handler ---
    async function triggerTask(endpoint, btnElement) {
        // 1. UI Loading State
        const originalContent = btnElement.innerHTML;
        btnElement.disabled = true;
        btnElement.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...`;

        log(`Starting task: ${endpoint}...`, 'info');

        try {
            // 2. 发起请求
            const res = await fetch(`${API}/api/actions/${endpoint}`, {
                method: 'POST',
                // 增加 timeout 处理 (如果是纯前端 fetch 无法直接设置 timeout，这里依靠 await 等待)
            });

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await res.text();
                throw new Error(`Server Error: ${res.status} ${text.substring(0, 50)}...`);
            }

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.detail || `HTTP ${res.status}`);
            }

            const data = await res.json();
            log(`${data.status || 'Success'} (ID: ${data.task_id || 'N/A'})`, 'success');

            // 3. 特殊逻辑处理
            if(endpoint === 'generate_dashboard') {
                log('Rendering charts... waiting 3s', 'info');
                setTimeout(refreshImages, 3000);
            }
            else if (endpoint === 'simulate_data') {
                log('Simulation complete. Auto-generating reports now...', 'info');
                // 模拟数据跑完后，自动触发生成报表，否则用户看不到变化
                triggerTask('generate_dashboard', document.querySelector("button[onclick*='generate_dashboard']"));
            }

        } catch (err) {
            console.error(err);
            log(`FAILED: ${err.message}`, 'error');
            if(err.message.includes("Failed to fetch")) {
                log("Is the backend running on port 8001?", 'error');
            }
        } finally {
            // 4. Restore UI
            if(endpoint !== 'simulate_data') {
                // 如果是 simulate data，因为我们链式调用了 generate_dashboard，
                // 这里的 button restore 可能会被覆盖，不过为了保险起见还是恢复
                btnElement.disabled = false;
                btnElement.innerHTML = originalContent;
            } else {
                 btnElement.disabled = false;
                 btnElement.innerHTML = originalContent;
            }
        }
    }

    function refreshImages() {
        const ts = new Date().getTime();
        ['chart-trend', 'chart-dau', 'chart-seg', 'chart-heat', 'chart-ret'].forEach(id => {
            const img = document.getElementById(id);
            if(img) {
                // 添加时间戳防止浏览器缓存
                img.src = img.src.split('?')[0] + '?t=' + ts;
                img.style.display = 'block';
            }
        });
        log('Charts visuals updated.', 'success');
    }

    async function searchUser(e) {
        e.preventDefault();
        const q = document.getElementById("search-q").value;
        const box = document.getElementById("search-res");
        box.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><br>Searching Database...</div>';

        try {
            const res = await fetch(`${API}/api/users/search?q=${encodeURIComponent(q)}`);
            if(!res.ok) throw new Error("Search failed");
            const data = await res.json();

            if(!data.length) {
                box.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8">No users found matching query.</div>';
                return;
            }

            // 渲染搜索结果
            box.innerHTML = data.map(u => `
                <div class="bg-slate-800 border border-slate-700 p-4 rounded-xl hover:border-brand-500 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-100 transition">
                         <i class="fa-solid fa-user text-brand-500"></i>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-slate-200 group-hover:text-brand-400 truncate pr-4">${u.nickname}</h4>
                    </div>
                    <div class="space-y-1">
                        <span class="text-xs bg-slate-900 px-2 py-1 rounded text-slate-400 border border-slate-700">ID: ${u.user_id}...</span>
                        <div class="text-xs text-slate-400 flex items-center gap-2 mt-2">
                            <i class="fa-regular fa-envelope w-3"></i> <span class="truncate">${u.email}</span>
                        </div>
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <i class="fa-solid fa-venus-mars w-3"></i> <span>${u.gender || 'N/A'} (${u.birth_year || '?'})</span>
                        </div>
                    </div>
                </div>
            `).join("");
        } catch(err) {
            box.innerHTML = `<div class="col-span-full text-center text-red-400 py-8">Error: ${err.message}</div>`;
        }
    }
  </script>
</body>
</html>
