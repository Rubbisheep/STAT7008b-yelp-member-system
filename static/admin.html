<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music App - Admin Dashboard</title>
  <style>
    :root { color-scheme: light; font-family: Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 16px 24px; background: #1f2937; color: #fff; }
    h1 { margin: 0; font-size: 22px; }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 8px 20px rgba(17, 24, 39, 0.08); }
    .card h2 { margin: 0 0 12px 0; font-size: 18px; }
    img { max-width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; }
    .note { margin-top: 24px; font-size: 14px; color: #4b5563; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Dashboard</h1>
  </header>
  <main>
    <div class="grid">
      <div class="card">
        <h2>Registration Trend</h2>
        <img src="../outputs/register_trend.png" alt="Registration Trend" />
      </div>
      <div class="card">
        <h2>Daily Active Users (DAU)</h2>
        <img src="../outputs/dau.png" alt="DAU" />
      </div>
      <div class="card">
        <h2>Favorite Genres</h2>
        <img src="../outputs/fav_genres.png" alt="Favorite Genres" />
      </div>
      <div class="card">
        <h2>Member vs Non-member</h2>
        <img src="../outputs/member_vs_non.png" alt="Member vs Non-member" />
      </div>
      <div class="card">
        <h2>User Segments</h2>
        <img src="../outputs/segments.png" alt="User Segments" />
      </div>
      <style>
        .result-card { background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin-top:8px; }
        .result-card h3 { margin:0 0 6px 0; font-size:16px; }
        .result-meta { font-size:12px; color:#6b7280; margin-bottom:4px; }
        .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; background:#e0e7ff; color:#1e3a8a; margin-right:6px; }
        .field { font-size:13px; margin:2px 0; }
        .field strong { color:#111827; }
      </style>
      <div class="card">
        <h2>User Lookup</h2>
        <form id="user-form">
          <label for="user-query-input" style="display:block;font-size:14px;margin-bottom:6px;color:#374151;">Search nickname / email / phone</label>
          <input id="user-query-input" type="text" placeholder="e.g. Alice or alice@example.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;box-sizing:border-box;margin-bottom:10px;" />
          <button type="submit" style="width:100%;padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;">Search</button>
        </form>
        <div id="user-result" style="margin-top:12px;max-height:280px;overflow:auto;"></div>
        <div style="margin-top:8px;font-size:12px;color:#6b7280;">Uses <code>GET /api/users/search?q=</code> to query SQLite via backend.</div>
      </div>
      <div class="card">
        <h2>Data Actions</h2>
        <button id="btn-init" style="width:100%;padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;margin-bottom:8px;">Init DB</button>
        <button id="btn-sim" style="width:100%;padding:10px;border:none;border-radius:8px;background:#16a34a;color:#fff;cursor:pointer;margin-bottom:8px;">Simulate Data</button>
        <button id="btn-gen" style="width:100%;padding:10px;border:none;border-radius:8px;background:#f59e0b;color:#fff;cursor:pointer;">Generate Dashboard</button>
        <pre id="actions-log" style="margin-top:12px;background:#f3f4f6;padding:10px;border-radius:8px;max-height:180px;overflow:auto;font-size:13px;">Use these to trigger backend scripts.</pre>
      </div>
    </div>
    <div class="note">
      Tip: run <code>python scripts/generate_dashboard.py</code> to refresh these figures after new data is loaded.
    </div>
  </main>
  <script>
    const form = document.getElementById("user-form");
    const input = document.getElementById("user-query-input");
    const result = document.getElementById("user-result");

    const API_BASE = window.API_BASE || ((location.port === "8000" || location.protocol === "file:") ? "http://localhost:8001" : location.origin);

    // Actions
    const btnInit = document.getElementById("btn-init");
    const btnSim = document.getElementById("btn-sim");
    const btnGen = document.getElementById("btn-gen");
    const logEl = document.getElementById("actions-log");
    let pollTimer = null;

    function setLog(text) {
      logEl.textContent = text;
    }

    async function pollStatus(taskId, label) {
      clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try {
          const resp = await fetch(`${API_BASE}/api/actions/status?task_id=${taskId}`);
          const data = await resp.json();
          setLog(`${label}: ${data.status || "unknown"}`);
          if (data.error) setLog(`${label}: failed - ${data.error}`);
          if (data.status === "completed" || data.status === "failed" || data.status === "unknown") {
            clearInterval(pollTimer);
          }
        } catch (err) {
          setLog(`Status error: ${err}`);
          clearInterval(pollTimer);
        }
      }, 1500);
    }

    async function trigger(path, label) {
      setLog(`Running ${label} ...`);
      clearInterval(pollTimer);
      try {
        const resp = await fetch(`${API_BASE}${path}`, { method: "POST" });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        setLog(`${label}: ${data.status || "queued"}`);
        if (data.task_id) {
          pollStatus(data.task_id, label);
        }
      } catch (err) {
        setLog(`Error on ${label}: ${err}`);
      }
    }

    btnInit.addEventListener("click", () => trigger("/api/actions/init_db", "Init DB"));
    btnSim.addEventListener("click", () => trigger("/api/actions/simulate_data", "Simulate Data"));
    btnGen.addEventListener("click", () => trigger("/api/actions/generate_dashboard", "Generate Dashboard"));

    function renderResults(data) {
      if (!data || data.length === 0) {
        result.innerHTML = "<div class='result-card'>No results</div>";
        return;
      }
      result.innerHTML = data.map(item => {
        const badges = [];
        if (item.status) badges.push(`<span class="badge">status: ${item.status}</span>`);
        if (item.membership_status) badges.push(`<span class="badge">membership: ${item.membership_status}</span>`);
        return `
          <div class="result-card">
            <h3>${item.nickname || '(no nickname)'} <span style="color:#6b7280;font-size:12px;">#${item.user_id}</span></h3>
            <div class="result-meta">Registered: ${item.register_time || '-'} | Source: ${item.register_source || '-'}</div>
            ${badges.join(' ')}
            <div class="field"><strong>Email:</strong> ${item.email || '-'}</div>
            <div class="field"><strong>Phone:</strong> ${item.phone || '-'}</div>
            <div class="field"><strong>Region:</strong> ${item.region || '-'}</div>
            <div class="field"><strong>Invited by:</strong> ${item.invited_by_user_id || '-'}</div>
            <div class="field"><strong>Fav genres:</strong> ${item.fav_genres || '-'}</div>
            <div class="field"><strong>Fav scenes:</strong> ${item.fav_scenes || '-'}</div>
            <div class="field"><strong>Extra info:</strong> ${item.extra_info || '-'}</div>
          </div>
        `;
      }).join("");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) {
        result.innerHTML = "<div class='result-card'>Please enter a nickname/email/phone to search.</div>";
        return;
      }
      result.innerHTML = "<div class='result-card'>Searching...</div>";
      try {
        const resp = await fetch(`${API_BASE}/api/users/search?q=${encodeURIComponent(q)}`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        renderResults(data);
      } catch (err) {
        result.innerHTML = `<div class='result-card'>Error: ${err}</div>`;
      }
    });
  </script>
</body>
</html>
